import { Transform } from 'pipestream';
import { fs, path } from '../import-pkg';
import * as util from '../util';
import config from '../config';
const weinreScriptFile = path.join(config.ASSESTS_PATH, 'js/weinre.js');
const weinreScript = fs.readFileSync(weinreScriptFile, { encoding: 'utf8' });
const weinreHtmlScript = '\r\n<script>' + weinreScript + '</script>\r\n';
function getScript(host, name, isHtml, req) {
    host = util.getInternalHost(req, host);
    const weinrePath = (req.isHttps ? 'https://' : 'http://') + host + config.WEBUI_PATH + 'weinre.' + config.port;
    const result = isHtml ? weinreHtmlScript : weinreScript;
    const weinreUrl = weinrePath + '/target/target-script-min.js#' + (name || 'anonymous');
    return result.replace('$WEINRE_PATH', weinrePath).replace('$WEINRE_URL', weinreUrl);
}
export function inspectWeire(req, res, next) {
    if (req.rules.weinre) {
        util.disableReqCache(req.headers);
        const host = req.headers.host;
        res.on('src', function (_res) {
            const isHtml = util.supportHtmlTransform(_res, req);
            if (!isHtml && util.getContentType(_res.headers) !== 'JS') {
                return;
            }
            !req.enable.keepAllCSP && util.disableCSP(_res.headers);
            !req._customCache && util.disableResStore(_res.headers);
            const name = util.getPath(util.rule.getMatcher(req.rules.weinre));
            const transform = new Transform();
            transform._transform = function (chunk, _, callback) {
                if (!chunk) {
                    chunk = util.toBuffer(getScript(host, name, isHtml, req));
                }
                callback(null, chunk);
            };
            res.addZipTransform(transform, false, true);
        });
    }
    next();
}

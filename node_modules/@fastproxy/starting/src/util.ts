import cp from 'child_process';

export const parseJSON = function parseJSON(data: any, decode: any): any {
  if (data) {
    try {
      data = JSON.parse(decode ? decodeURIComponent(data) : data);
    } catch (e) {
      data = null;
    }
  }

  return data || {};
};

export const setSudoGid = function setSudoGid(): void {
  if (process.setgid && process.getgid) {
    process.umask('002');
    process.setgid(parseInt(`${process.env.SUDO_GID || process.getgid()}`, 10));
  }
};

export const getVersion = function getVersion(execPath: any): string {
  if (!execPath) {
    return process.version;
  }
  if (typeof cp.spawnSync === 'function') {
    try {
      if (/v\d+\.\d+\.\d+/.test(String(cp.spawnSync(execPath, ['-v']).output))) {
        return RegExp['$&'];
      }
    } catch (e) {}
  }
  return '';
};

export const getMaxSemiSpaceFlag = function getMaxSemiSpaceFlag(version: any): string | undefined {
  const major = parseInt(version.substring(1, version.indexOf('.')), 10);
  if (major < 6) {
    return;
  }
  return major > 9 ? '--max-semi-space-size' : '--max_semi_space_size';
};
